<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文本重复项分析与链接提取</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
        
        body {
            font-family: 'Inter', "Microsoft YaHei", sans-serif;
            height: 100vh;
            overflow: hidden;
        }

        /* 自定义滚动条样式 */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .highlight-box {
            white-space: pre-wrap;
            word-break: break-all;
            line-height: 1.8;
        }

        mark {
            border-radius: 4px;
            padding: 0 2px;
            color: inherit;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">

    <div class="flex flex-col h-screen">
        <!-- 导航栏 -->
        <header class="bg-white border-b px-6 py-4 flex justify-between items-center shadow-sm z-10">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-blue-600 rounded flex items-center justify-center text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21 21-4.3-4.3"/><circle cx="10" cy="10" r="7"/><path d="M7 9h5"/><path d="M10 7v5"/></svg>
                </div>
                <h1 class="text-xl font-bold tracking-tight">文本分析助手</h1>
            </div>
            <div class="flex gap-3">
                <button onclick="clearText()" class="px-4 py-2 text-sm font-medium text-slate-600 hover:text-slate-800 transition-colors">
                    清除内容
                </button>
                <button onclick="processText()" class="px-6 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 shadow-sm transition-all">
                    立即分析
                </button>
            </div>
        </header>

        <!-- 主体内容 -->
        <main class="flex-1 flex overflow-hidden p-4 gap-4">
            
            <!-- 左侧：文本输入区 -->
            <div class="flex-1 flex flex-col bg-white rounded-xl border shadow-sm overflow-hidden">
                <div class="px-4 py-2 border-b bg-slate-50 text-xs font-semibold text-slate-500 uppercase tracking-wider">
                    输入待处理文本
                </div>
                <textarea id="inputText" class="flex-1 p-4 outline-none resize-none text-slate-700 leading-relaxed custom-scrollbar" placeholder="在此粘贴文字内容..."></textarea>
            </div>

            <!-- 右侧：结果展示区 -->
            <div class="flex-1 flex flex-col gap-4 overflow-hidden">
                
                <!-- 链接提取列表 -->
                <div class="h-1/3 flex flex-col bg-white rounded-xl border shadow-sm overflow-hidden">
                    <div class="px-4 py-2 border-b bg-slate-50 flex justify-between items-center">
                        <span class="text-xs font-semibold text-slate-500 uppercase tracking-wider">提取的链接 (weixinstore)</span>
                        <span id="linkCount" class="text-xs px-2 py-0.5 bg-blue-100 text-blue-700 rounded-full font-bold">0</span>
                    </div>
                    <div id="linksOutput" class="flex-1 p-4 overflow-y-auto custom-scrollbar text-sm text-blue-600 underline space-y-1 font-mono">
                        <p class="text-slate-400 italic">尚未提取到链接</p>
                    </div>
                </div>

                <!-- 重复项高亮展示 -->
                <div class="flex-1 flex flex-col bg-white rounded-xl border shadow-sm overflow-hidden">
                    <div class="px-4 py-2 border-b bg-slate-50 flex justify-between items-center">
                        <span class="text-xs font-semibold text-slate-500 uppercase tracking-wider">两字及以上重复项分析 (已排除白名单)</span>
                        <div class="flex gap-2">
                            <span id="repeatCount" class="text-xs px-2 py-0.5 bg-amber-100 text-amber-700 rounded-full font-bold">0 个重复模式</span>
                        </div>
                    </div>
                    <div id="highlightResult" class="flex-1 p-6 overflow-y-auto custom-scrollbar highlight-box text-slate-700">
                        <p class="text-slate-400 italic">分析结果将显示在这里...</p>
                    </div>
                </div>

            </div>
        </main>

        <!-- 页脚状态栏 -->
        <footer class="bg-white border-t px-6 py-2 text-xs text-slate-400 flex justify-between items-center">
            <span>支持 weixinstore 链接提取 | 重复项阈值: 2字 (排除: 用这, 这个, 链接, 换新)</span>
            <span id="charCount">当前字数: 0</span>
        </footer>
    </div>

    <script>
        // 预定义的高亮颜色库
        const colors = [
            '#FFEBEE', '#F3E5F5', '#E8EAF6', '#E3F2FD', '#E0F2F1', '#F1F8E9', 
            '#FFFDE7', '#FFF3E0', '#EFEBE9', '#FFD54F', '#81C784', '#64B5F6',
            '#BA68C8', '#FF8A65', '#DCE775', '#A1887F', '#90A4AE', '#FFCDD2'
        ];

        // 白名单词汇：即使重复也不会被高亮
        const whitelist = ['用这', '这个', '链接', '换新', '换新链接', '链接换新', '备用链接', '价格'];

        // 清除文本和结果
        function clearText() {
            document.getElementById('inputText').value = '';
            document.getElementById('linksOutput').innerHTML = '<p class="text-slate-400 italic">尚未提取到链接</p>';
            document.getElementById('highlightResult').innerHTML = '<p class="text-slate-400 italic">分析结果将显示在这里...</p>';
            document.getElementById('linkCount').innerText = '0';
            document.getElementById('repeatCount').innerText = '0 个重复模式';
            updateCharCount();
        }

        // 更新字数统计
        function updateCharCount() {
            const text = document.getElementById('inputText').value;
            document.getElementById('charCount').innerText = `当前字数: ${text.length}`;
        }

        document.getElementById('inputText').addEventListener('input', updateCharCount);

        // 主处理逻辑
        function processText() {
            const text = document.getElementById('inputText').value;
            if (!text.trim()) return;

            // 执行提取链接和高亮分析
            extractLinks(text);
            highlightRepeats(text);
        }

        // 提取以 weixinstore 开头的链接
        function extractLinks(text) {
            const linkRegex = /weixinstore[a-zA-Z0-9.\-_~:/?#[\]@!$&'()*+,;=]+/g;
            const matches = text.match(linkRegex) || [];
            const output = document.getElementById('linksOutput');
            const countBadge = document.getElementById('linkCount');

            if (matches.length === 0) {
                output.innerHTML = '<p class="text-slate-400 italic">未发现相关链接</p>';
                countBadge.innerText = '0';
                return;
            }

            const uniqueLinks = [...new Set(matches)];
            countBadge.innerText = uniqueLinks.length;
            output.innerHTML = uniqueLinks.map(link => `
                <div class="break-all py-1 border-b border-slate-50 last:border-0 hover:bg-slate-50 transition-colors">
                    <a href="${link.startsWith('http') ? link : 'https://' + link}" target="_blank">${link}</a>
                </div>
            `).join('');
        }

        // 查找重复项并进行颜色标注
        function highlightRepeats(text) {
            const minLen = 2; 
            let repeats = new Map();
            
            // 为了性能，设定最大检测长度
            const maxScanLen = Math.min(text.length / 2, 20);

            // 从长到短进行滑动窗口扫描
            for (let len = Math.floor(maxScanLen); len >= minLen; len--) {
                for (let i = 0; i <= text.length - len; i++) {
                    let sub = text.substring(i, i + len);
                    
                    // 只处理纯汉字
                    if (!/^[\u4e00-\u9fa5]+$/.test(sub)) continue;
                    
                    // 检查是否在白名单中
                    if (whitelist.includes(sub)) continue;
                    
                    // 避免长项被包含在已有的更长项中
                    let alreadyCovered = false;
                    for (let existing of repeats.keys()) {
                        if (existing.includes(sub)) {
                            alreadyCovered = true;
                            break;
                        }
                    }
                    if (alreadyCovered) continue;

                    // 计算该子串在全文中出现的次数
                    let count = 0;
                    let pos = text.indexOf(sub);
                    while (pos !== -1) {
                        count++;
                        pos = text.indexOf(sub, pos + 1);
                    }

                    if (count > 1) {
                        repeats.set(sub, count);
                    }
                }
            }

            const repeatKeys = Array.from(repeats.keys());
            document.getElementById('repeatCount').innerText = `${repeatKeys.length} 个重复模式`;

            if (repeatKeys.length === 0) {
                document.getElementById('highlightResult').innerText = text;
                return;
            }

            // 安全转义文本
            let displayHTML = text.replace(/[<>&]/g, c => ({'<':'&lt;','>':'&gt;','&':'&amp;'}[c]));
            
            // 按照长度降序排列模式，确保替换逻辑的正确性
            repeatKeys.sort((a, b) => b.length - a.length);

            // 使用占位符防止 HTML 标签嵌套污染
            const placeholders = [];
            repeatKeys.forEach((pattern, idx) => {
                const color = colors[idx % colors.length];
                const escapedPattern = pattern.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const regex = new RegExp(escapedPattern, 'g');
                
                const placeholder = `___REMARK_${idx}___`;
                placeholders.push({
                    id: placeholder,
                    html: `<mark style="background-color: ${color}; border-bottom: 2px solid rgba(0,0,0,0.1);" title="出现次数: ${repeats.get(pattern)}">${pattern}</mark>`
                });

                displayHTML = displayHTML.replace(regex, placeholder);
            });

            // 将占位符还原为真正的带颜色标签
            placeholders.forEach(p => {
                const regex = new RegExp(p.id, 'g');
                displayHTML = displayHTML.replace(regex, p.html);
            });

            document.getElementById('highlightResult').innerHTML = displayHTML;
        }
    </script>
</body>
</html>
